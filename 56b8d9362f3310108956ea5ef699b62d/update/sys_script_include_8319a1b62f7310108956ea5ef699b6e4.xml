<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_caci_cisco_bcs.Cisco_DAOScript</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>Cisco_DAOScript</name>
        <script><![CDATA[var Cisco_DAOScript = Class.create();

Cisco_DAOScript.prototype = {
    initialize: function() {
        this.logger = new Cisco_BCS_SNLogger();
        this.table = {
            "processQueue": "x_caci_cisco_bcs_cisco_import_queue",
            "fieldNoticesDump": "x_caci_cisco_bcs_cisco_field_notices_dump_v2",
            "securityAdvisoriesDump": "x_caci_cisco_bcs_cisco_security_advisories_dump_v2",
            "softwareLifecycleDump": "x_caci_cisco_bcs_cisco_software_lifecycle_dump_v2",
            "softwareLifecycle": "x_caci_cisco_bcs_cisco_software_lifecycle",
            "hardwareLifecycleDump": "x_caci_cisco_bcs_cisco_hardware_lifecycle_dump_v2",
            "fieldNotices": "x_caci_cisco_bcs_cisco_field_notices",
            "securityAdvisories": "x_caci_cisco_bcs_cisco_security_advisories",
            "hardwareLifecycle": "x_caci_cisco_bcs_cisco_hardware_lifecycle",
            "authentication": "x_caci_cisco_bcs_configuration",
            "assetsDump": "x_caci_cisco_bcs_cisco_assets_dump_v2",
            "devicesDump": "x_caci_cisco_bcs_cisco_devices_dump_v2",
            "assets": "x_caci_cisco_bcs_cisco_assets",
            "devices": "x_caci_cisco_bcs_cisco_devices",
            "softwareLifecycleBulletinsDump": "x_caci_cisco_bcs_cisco_sw_eox_bulletins_dump_v2",
            "hardwareLifecycleBulletinDump": "x_caci_cisco_bcs_cisco_hw_eox_bulletins_dump_v2",
            "hardwareLifecycleBulletin": "x_caci_cisco_bcs_cisco_hw_eox_bulletins",
            "softwareLifecycleBulletin": "x_caci_cisco_bcs_cisco_sw_eox_bulletins",
            "securityAdvisoriesbulletinDump": "x_caci_cisco_bcs_cisco_security_advisories_bulletins_dump_v2",
            "fiedlNoticesBulletinDump": "x_caci_cisco_bcs_cisco_fn_bulletins_dump_v2",
            "securityAdvisoryBulletins": "x_caci_cisco_bcs_cisco_security_advisories_bulletins",
            "fieldNoticesBulletin": "x_caci_cisco_bcs_cisco_fn_bulletin",
            "cbpDetails": "x_caci_cisco_bcs_cisco_cbp_details",
            "cbpRules": "x_caci_cisco_bcs_cisco_cbp_rules",
            "cbpSummary": "x_caci_cisco_bcs_cisco_cbp_summary",
            "cbpDetailsDump": "x_caci_cisco_bcs_cisco_cbp_details_dump_v2",
            "cbpRulesDump": "x_caci_cisco_bcs_cisco_cbp_rules_dump_v2",
            //"ConfigBestPractices rules Dump V2": "x_caci_cisco_bcs_configbestpractices_rules_dump",
            "cbpSummaryDump": "x_caci_cisco_bcs_cisco_cbp_summary_dump_v2",
            "contractLifecycleDump": "x_caci_cisco_bcs_cisco_contract_lifecycle_dump_v2",
            "contractLifecycle": "x_caci_cisco_bcs_cisco_contract_lifecycle",
            "contractBulletin": "x_caci_cisco_bcs_cisco_contract_bulletin",
            "contractLifecycleBulletin": "x_caci_cisco_bcs_cisco_contract_bulletin",
            "cbpRulesReferences": "x_caci_cisco_bcs_cbp_rules_references",
            "riskMitigationDetailsDump": "x_caci_cisco_bcs_cisco_risk_mitigation_details_dump_v2",
            "riskMitigationSummaryDump": "x_caci_cisco_bcs_cisco_risk_mitigation_summary_dump_v2",
            "deviceResetCountDump": "x_caci_cisco_bcs_cisco_device_reset_reset_count_dump_v2",
            "deviceResetLastResetDetailsDump": "x_caci_cisco_bcs_cisco_device_lastresetdetails_dump_v2",
            "deviceResetHistoryDump": "x_caci_cisco_bcs_cisco_device_reset_history_dump_v2",
            "cbpRulesReferencesDump": "x_caci_cisco_bcs_cisco_cbp_rules_references_dump_v2",
            "softwaretrackSummaryDump": "x_caci_cisco_bcs_cisco_software_track_summary_dump_v2",
            "softwaretrackMembersDump": "x_caci_cisco_bcs_cisco_software_track_members_dump_v2",
            "softwaretrackComplianceDump": "x_caci_cisco_bcs_cisco_sw_track_maintenance_upgrade_compliance_dump_v2",
            "softwaretrackReccommendationsDump": "x_caci_cisco_bcs_cisco_sw_track_maintenance_upgraderecommendations_dump_v2",

            "riskMitigationDetails": "x_caci_cisco_bcs_cisco_risk_mitigation_details",
            "riskMitigationSummary": "x_caci_cisco_bcs_cisco_risk_mitigation_summary",
            "deviceResetCount": "x_caci_cisco_bcs_device_reset_count",
            "deviceResetLastResetDetails": "x_caci_cisco_bcs_device_reset_details",
            "deviceResetHistory": "x_caci_cisco_bcs_cisco_device_reset_history",
            "softwaretrackSummary": "x_caci_cisco_bcs_cisco_software_track_summary",
            "softwaretrackMembers": "x_caci_cisco_bcs_cisco_software_track_members",
            "softwaretrackCompliance": "x_caci_cisco_bcs_cisco_sw_track_maintenance_upgrade_compliance",
            "softwaretrackReccommendations": "x_caci_cisco_bcs_cisco_sw_track_maintenance_upgrade_recommendations",

            "syslogDaily": "x_caci_cisco_bcs_cisco_syslog_daily",
            "syslogDailyDump": "x_caci_cisco_bcs_cisco_syslog_daily_dump_v2",

            "deviceName": "x_caci_cisco_bcs_device_name",
            "devicehistoryRelation": "x_caci_cisco_bcs_cisco_device_reset_history_rel",

            "placeInNetworkDump": "x_caci_cisco_bcs_cisco_place_in_network_dump",
            "unidentifiedInventoryDetailsDump": "x_caci_cisco_bcs_unidentified_inventory_details_dump",
            //"unidentifiedInventorysummaryDump": "x_caci_cisco_bcs_cisco_unidentified_inventory_summary_dump",

            "placeInNetwork": "x_caci_cisco_bcs_place_in_network",
            "unidentifiedInventoryDetails": "x_caci_cisco_bcs_unidentified_inventory_details"
            //"unidentifiedInventorysummary": "x_caci_cisco_bcs_unidentified_inventory_summary"
        };
        this.property = {
            "retentionPeriod": gs.getProperty("x_caci_cisco_bcs.retention.period"),
            "authRec": gs.getProperty("x_caci_cisco_bcs.Authentication.Record") + '',
            "vendor": gs.getProperty("x_caci_cisco_bcs.core_company")
        };
    },
    checkForContractVendor: function() {
        try {
            var gr = new GlideRecord("core_company");
            gr.addQuery('name', 'Cisco');
            gr.query();
            if (gr.next()) {
                gs.setProperty("x_caci_cisco_bcs.core_company", gr.sys_id);
            } else {
                gr.initialize();
                gr.name = "Cisco";
                gs.setProperty("x_caci_cisco_bcs.core_company", gr.insert());
            }
        } catch (e) {
            this.logger.error("Exception inside checkForContractVendor: " + e);
        }
    },
    assetCalculatedFields: function(contract, target) {
        var grContract = new GlideRecord('x_caci_cisco_bcs_cisco_contract_lifecycle');
        grContract.addQuery("customer_id", target.customer_id);
        if (grContract.get(contract + "")) {

            // expired_status
            if (grContract.covered_product_line_end_date == "")
                target.expired_status = '';
            else if (grContract.covered_product_line_end_date > gs.endOfToday())
                target.expired_status = 'Not expired';
            else if (grContract.covered_product_line_end_date < gs.endOfToday())
                target.expired_status = 'Expired';

            // warranty_status
            if (grContract.warranty_end_date == "")
                target.warranty_status = '';
            else if (grContract.warranty_end_date > gs.endOfToday())
                target.warranty_status = 'Under warranty';
            else if (grContract.warranty_end_date < gs.endOfToday())
                target.warranty_status = 'Out of warranty';

            //contract_status
            if (grContract.is_covered == true)
                target.contract_status = 'Under contract';
            else if (grContract.is_covered == false)
                target.contract_status = 'Not under contract';

            //cisco_support_eligible
            if (grContract.is_covered + "" == true || grContract.warranty_end_date > gs.endOfToday())
                target.cisco_support_eligible = true;
            else
                target.cisco_support_eligible = false;

            target.update();
        }
    },

    resetHistoryCalculatedFields: function(deviceId, target) {
        var grMitigation = new GlideRecord('x_caci_cisco_bcs_cisco_risk_mitigation_details');
        grMitigation.addQuery('customer_id', target.customer_id);
        grMitigation.addQuery('deviceid', deviceId.toString());
        grMitigation.query();
        if (grMitigation.next()) {
            target.risk_category = grMitigation.riskcategory + '';
            target.risk_score = grMitigation.riskscore + '';
            target.update();
        }
        var rs = new GlideRecord("x_caci_cisco_bcs_cisco_device_reset_history");
        rs.addQuery('customer_id', target.customer_id);
        rs.addQuery('deviceid', deviceId.toString());
        rs.query();
        if (rs.next()) {
            var parsedData = JSON.parse(rs.resetdetails);
            var length = parsedData.length;
            target.total_reset = length;
            target.update();
        }
    },

    //     syslogCalculatedFields: function(target) {

    //         var rs = new GlideRecord("x_caci_cisco_bcs_cisco_syslog_daily");
    //         rs.addQuery('sys_id', target.sys_id);
    //         rs.query();
    //         if (rs.next()) {
    //             var parsedData = JSON.parse(rs.devices);
    //             var length = parsedData.length;
    //             target.no_of_devices = length;
    //             target.update();
    //         }
    //     },

    swComplianceCalculatedFields: function(softwaretrackid, target) {
        var output = [];
        var gr_com = new GlideRecord('x_caci_cisco_bcs_cisco_sw_track_maintenance_upgrade_recommendations');
        gr_com.addQuery("customer_id", target.customer_id);
        gr_com.addQuery('softwaretrackid', softwaretrackid.toString());
        gr_com.query();
        var count = 0;
        while (gr_com.next()) {
            count++;
        }
        if (count > 0)
            target.recommendations = true;
        else
            target.recommendations = false;
        target.update();

    },


    swComplianceRecommendation: function(softwaretrackid, softwaretrackrecommendationhistory, target) {
        var gr_com = new GlideRecord('x_caci_cisco_bcs_cisco_software_track_summary');
        gr_com.addQuery('customer_id', target.customer_id);
        gr_com.addQuery('softwaretrackid', softwaretrackid.toString());
        gr_com.query();
        if (gr_com.next()) {
            if (softwaretrackrecommendationhistory == 'Previous1') {
                target.softwareversion = gr_com.softwaretrackpreviousversion1;
            } else if (softwaretrackrecommendationhistory == 'Previous2') {
                target.softwareversion = gr_com.softwaretrackpreviousversion2;
            } else {
                target.softwareversion = gr_com.softwaretrackstandardversion;
            }
            target.update();
        }


    },


    insertInAssetCovered: function(selfRef, targetFieldName, serialNumber, targetTable, isContract) {
        try {

            var targetRef = "";
            try {
                this.logger.info("Inside Cisco_DAOScript.insertInAssetCovered gettting asset and contract no");

                var assetContract = new GlideRecord(this.table[targetTable]);
                assetContract.addQuery(targetFieldName, serialNumber + "");
                assetContract.query();
                if (assetContract.next())
                    targetRef = assetContract.sys_id + "";
                else {
                    return;
                }

            } catch (e) {
                this.logger.error("Inside Cisco_DAOScript.insertInAssetCovered: " + e);
            }

            try {
                var assetCovered = new GlideRecord("clm_m2m_contract_asset");
                if (isContract) {
                    if (selfRef.contract_bulletin == "")
                        return;

                    assetCovered.addQuery("asset", targetRef);
                    assetCovered.addQuery("contract", selfRef.contract_bulletin + "");
                } else {
                    var target = new GlideRecord("x_caci_cisco_bcs_cisco_contract_lifecycle");
                    if (target.get(targetRef)) {
                        if (target.contract_bulletin == "")
                            return;

                        assetCovered.addQuery("contract", target.contract_bulletin + "");
                        //                     insertAssetCovered.contract = target.contract_bulletin;
                    }
                    //                 assetCovered.addQuery("contract",targetRef.contract_bulletin);

                    assetCovered.addQuery("asset", selfRef.sys_id);

                }

                assetCovered.query();
                if (!assetCovered.next()) {


                    var insertAssetCovered = new GlideRecord("clm_m2m_contract_asset");
                    insertAssetCovered.initialize();
                    if (isContract) {

                        insertAssetCovered.asset = targetRef;
                        insertAssetCovered.contract = selfRef.contract_bulletin;
                    } else {
                        var target = new GlideRecord("x_caci_cisco_bcs_cisco_contract_lifecycle");
                        if (target.get(targetRef)) {
                            insertAssetCovered.contract = target.contract_bulletin;
                        }

                        insertAssetCovered.asset = selfRef.sys_id;
                    }

                    insertAssetCovered.added = new GlideDate();
                    insertAssetCovered.insert();
                }
            } catch (e) {
                this.logger.error("Inside Cisco_DAOScript.insertInAssetCovered:" + e);
            }



        } catch (e) {
            this.logger.error("Exception Inside Cisco_DAOScript.insertInAssetCovered() gettting asset and contract no" + e);
        }
    },
    createContractBulletin: function(lifecycleRef) {
        try {
            this.logger.debug("Inside Cisco_DAOScript.createContractBulletin creating new Contract Bulletin records");
            var bulletin = new GlideRecord("x_caci_cisco_bcs_cisco_contract_bulletin");

            if (lifecycleRef.service_contract_number != "") {

                bulletin.addQuery("service_contract_number", lifecycleRef.service_contract_number + "");
                bulletin.query();
                if (!bulletin.next()) {

                    var createBulletin = new GlideRecord("x_caci_cisco_bcs_cisco_contract_bulletin");
                    createBulletin.initialize();
                    createBulletin.service_contract_number = lifecycleRef.service_contract_number + "";

                    createBulletin.vendor = this.property.vendor;
                    createBulletin.vendor_contract = lifecycleRef.service_contract_number + "";
                    createBulletin.contract_site_customer_name = lifecycleRef.contract_site_customer_name;
                    createBulletin.contract_site_address_1 = lifecycleRef.contract_site_address_1;
                    createBulletin.contract_site_city = lifecycleRef.contract_site_city;
                    createBulletin.contract_site_state_province = lifecycleRef.contract_site_state_province;
                    createBulletin.contract_site_country = lifecycleRef.contract_site_country;
                    createBulletin.covered_product_line_end_date = lifecycleRef.covered_product_line_end_date;
                    //  createBulletin.ends = lifecycleRef.covered_product_line_end_date;
                    createBulletin.is_covered = lifecycleRef.is_covered;
                    if (lifecycleRef.is_covered + "" == "YES")
                        createBulletin.active = true;
                    else
                        createBulletin.active = false;
                    createBulletin.description = lifecycleRef.service_line_descr;
                    lifecycleRef.contract_bulletin = createBulletin.insert();
                    lifecycleRef.update();
                } else {

                    bulletin.vendor = this.property.vendor;
                    bulletin.vendor_contract = lifecycleRef.service_contract_number + "";
                    bulletin.contract_site_customer_name = lifecycleRef.contract_site_customer_name;
                    bulletin.contract_site_address_1 = lifecycleRef.contract_site_address_1;
                    bulletin.contract_site_city = lifecycleRef.contract_site_city;
                    bulletin.contract_site_state_province = lifecycleRef.contract_site_state_province;
                    bulletin.contract_site_country = lifecycleRef.contract_site_country;
                    bulletin.covered_product_line_end_date = lifecycleRef.covered_product_line_end_date;
                    //  bulletin.ends = lifecycleRef.covered_product_line_end_date;
                    bulletin.is_covered = lifecycleRef.is_covered;
                    if (lifecycleRef.is_covered + "" == "YES")
                        bulletin.active = true;
                    else
                        bulletin.active = false;
                    bulletin.description = lifecycleRef.service_line_descr;

                    lifecycleRef.contract_bulletin = bulletin.update();
                    lifecycleRef.update();
                }
            }
        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.createContractBulletin . Error :- " + e);
        }
    },
    getOptionsCurrentMilestoneHardwareLifecycle: function() {
        var id = this.getclientid();
        var output = {};
        var ga = new GlideAggregate('x_caci_cisco_bcs_cisco_hardware_lifecycle');
        ga.addQuery("customer_id", id);
        ga.addAggregate('COUNT', 'current_milestone');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.current_milestone + "")
                result.push(ga.current_milestone + "");
        }
        output["milestone"] = result;
        result = [];
        ga = new GlideAggregate('x_caci_cisco_bcs_cisco_hardware_lifecycle');
        ga.addQuery("customer_id", id);
        ga.addAggregate('COUNT', 'physical_type');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.physical_type + "")
                result.push(ga.physical_type + "");
        }
        output["hardwareType"] = result;
        return JSON.stringify(output);
    },

    getOptionsNextMilestoneHardwareLifecycle: function() {
        var id = this.getclientid();
        var output = {};
        var ga = new GlideAggregate('x_caci_cisco_bcs_cisco_hardware_lifecycle');
        ga.addQuery('customer_id', id);
        ga.addAggregate('COUNT', 'next_milestone');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.next_milestone + "")
                result.push(ga.next_milestone + "");
        }
        output["milestone"] = result;
        result = [];
        ga = new GlideAggregate('x_caci_cisco_bcs_cisco_hardware_lifecycle');
        ga.addQuery('customer_id', id);
        ga.addAggregate('COUNT', 'physical_type');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.physical_type + "")
                result.push(ga.physical_type + "");
        }
        output["hardwareType"] = result;
        return JSON.stringify(output);
    },

    getOptionsNextMilestoneSoftwareLifecycle: function() {
        var id = this.getclientid();
        var output = {};
        var ga = new GlideAggregate('x_caci_cisco_bcs_cisco_software_lifecycle');
        ga.addQuery('customer_id', id);
        ga.addAggregate('COUNT', 'next_milestone');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.next_milestone + "")
                result.push(ga.next_milestone + "");
        }
        output["milestone"] = result;
        result = [];
        ga = new GlideAggregate('x_caci_cisco_bcs_cisco_software_lifecycle');
        ga.addQuery('customer_id', id);
        ga.addAggregate('COUNT', 'sw_type');
        ga.query();
        var result = [];
        while (ga.next()) {
            if (ga.sw_type + "")
                result.push(ga.sw_type + "");
        }
        output["hardwareType"] = result;
        return JSON.stringify(output);
    },

    insertIntoQueue: function(topic, parameter, payload, client_id, bcs_account) {
        try {

            this.logger.debug("Inside Cisco_DAOScript.insertIntoQueue performing insertion into queue.");
            gs.setProperty("x_caci_cisco_bcs.cisco_threadactivatated", true);
            var gr = new GlideRecord(this.table.processQueue);
            gr.initialize();
            gr.topic = topic + '';
            gr.parameter = parameter + '';
            gr.payload = payload + '';
            gr.state = "ready";
            gr.bcs = bcs_account + '';
            gr.customer_id = client_id + '';
            gr.insert();
        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.insertIntoQueue while insert data into Queue table. Error :- " + e);
        }
    },

    createReferences: function(selfFieldValue, targetField, targetSelfReference, target_sys_id, targetTable, updateTarget, ClientID) {

        try {
            var grReferencedTable = new GlideRecord(targetTable);
            grReferencedTable.addQuery(targetField, selfFieldValue + "");
            grReferencedTable.addQuery('customer_id', ClientID);
            grReferencedTable.query();
            var refSysId = "";
            while (grReferencedTable.next()) {
                refSysId = grReferencedTable.sys_id + "";
                if (updateTarget) {
                    grReferencedTable[targetSelfReference] = target_sys_id;
                    grReferencedTable.update();
                }
                //return refSysId;
            }

            return refSysId;
        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.createReferences. Error :- " + e);
        }
    },

    createsyslogReferences: function(selfFieldValue, targetField, targetSelfReference, target_sys_id, targetTable, updateTarget, ClientId) {

        try {
            var grReferencedTable = new GlideRecord(targetTable);
            grReferencedTable.addQuery('customer_id', ClientId);
            grReferencedTable.addQuery(targetField, selfFieldValue + "");
            grReferencedTable.query();
            var refSysId = "";
            gs.info('insertmsg_type_syslog: ' + selfFieldValue + targetField + targetSelfReference + target_sys_id + targetTable + updateTarget);
            var pre_data = [];
            var final_msg_array = [];
            while (grReferencedTable.next()) {
                refSysId = grReferencedTable.sys_id + "";
                if (updateTarget) {
                    //                     var abc = [];
                    //                     abc = grReferencedTable.getValue('targetSelfReference');
                    // 					pre_data.push(abc);
                    pre_data.push(grReferencedTable[targetSelfReference] + '');
                    gs.info('insertmsg_type_pre_data: ' + pre_data);
                    if (pre_data != '') {

                        var msg_array = pre_data.toString().split(',');
                        gs.info('insertmsg_type_split: ' + msg_array + msg_array.length);
                        for (var i = 0; i < msg_array.length; i++) {
                            final_msg_array.push(msg_array[i]);
                        }
                    }
                    gs.info('insertmsg_type_old: ' + final_msg_array);
                    final_msg_array.push(target_sys_id);
                    // grReferencedTable[targetSelfReference] = target_sys_id;
                    //grReferencedTable[targetSelfReference] = final_msg_array;
                    var final_list = [];
                    final_list = final_msg_array.join(',');
                    grReferencedTable[targetSelfReference] = final_list;
                    gs.info('insertmsg_type: ' + final_msg_array + target_sys_id);
                    grReferencedTable.update();
                }
                //return refSysId;
            }

            return refSysId;
        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.createsyslogReferences. Error :- " + e);
        }
    },

    calculateField: function(targetTableName, groupByField, query, ClientId) {
        var i = 0;
        var grFN = new GlideAggregate(targetTableName); //call(TargettableName,"groupByField",Query,fromSource)
        if (groupByField)
            grFN.addAggregate('COUNT', groupByField);
        grFN.addQuery('customer_id', ClientId);
        grFN.addEncodedQuery(query);
        grFN.query();
        while (grFN.next())
            i++;
        return i;
    },

    //updateCaluclatedField("x_caci_cisco_bcs_cisco_devices","device_id="+target.device_id+"","vulnerable_field_notices");

    updateCalculatedField: function(tableName, query, calculatedFieldName, calculatedFieldValue, ClientId) {
        var gr = new GlideRecord(tableName);
        gr.addQuery('customer_id', ClientId);
        gr.addEncodedQuery(query);
        gr.query();
        if (gr.next()) {
            gr[calculatedFieldName] = calculatedFieldValue;
            gr.update();
        }
    },
    getDevicename: function(SelfFieldValue, Targetfield, TargetTable, ClientId) {
        var grDeviceTable = new GlideRecord(TargetTable);
        grDeviceTable.addQuery("customer_id", ClientId);
        grDeviceTable.addQuery(Targetfield, SelfFieldValue);
        grDeviceTable.query();
        while (grDeviceTable.next()) {
            return grDeviceTable.name;
        }
    },
    getProductdetails: function(SelfFieldValue, Targetfield, TargetTable, ClientId) {
        var grProductid = new GlideRecord(TargetTable);
        grProductid.addQuery("customer_id", ClientId);
        grProductid.addQuery(Targetfield, SelfFieldValue);
        grProductid.query();
        if (grProductid.next()) {
            return grProductid.product_id;
        }
    },
    getSoftwareVersion: function(SelfFieldValue, Targetfield, TargetTable, ClientId) {
        var grSoftwareVersion = new GlideRecord(TargetTable);
        grSoftwareVersion.addQuery("customer_id", ClientId);
        grSoftwareVersion.addQuery(Targetfield, SelfFieldValue);
        grSoftwareVersion.query();
        if (grSoftwareVersion.next()) {
            return grSoftwareVersion.sw_version;
        }
    },
    crashRiskCategory: function(selfFieldValue, targetField, targetTable, ClientId) {
        var setfiedValue = selfFieldValue.toString();
        var grriskCategory = new GlideRecord(targetTable);
        grriskCategory.addQuery("customer_id", ClientId);
        grriskCategory.addQuery(targetField, selfFieldValue);
        grriskCategory.query();
        if (grriskCategory.next()) {
            return grriskCategory.riskcategory;

        }
    },

    totalOfEvents: function(selfFieldValue, targetField, targetTable, ClientId) {
        //var setfiedValue = parseInt(selfFieldValue);
        var aggEvent = new GlideAggregate(targetTable);
        aggEvent.addQuery("customer_id", ClientId);
        aggEvent.addQuery(targetField, selfFieldValue);
        //aggEvent.addAggregate('SUM', 'eventcount');
        //aggEvent.setGroup('deviceid');
        aggEvent.query();
        var total = 0;
        while (aggEvent.next()) {
            total = total + aggEvent.eventcount;
        }
        return total;
    },
    getTargetTableName: function(tableName) {
        var dump_target_relation = {
            "devicesDump": this.table.devices,
            "softwareLifecycleBulletinsDump": this.table.softwareLifecycleBulletin,
            "hardwareLifecycleBulletinDump": this.table.hardwareLifecycleBulletin,
            "securityAdvisoriesbulletinDump": this.table.securityAdvisoryBulletins,
            "fiedlNoticesBulletinDump": this.table.fieldNoticesBulletin,
            "assetsDump": this.table.assets,
            "cbpRulesDump": this.table.cbpRules,
            "securityAdvisoriesDump": this.table.securityAdvisories,
            "hardwareLifecycleDump": this.table.hardwareLifecycle,
            "softwareLifecycleDump": this.table.softwareLifecycle,
            "cbpSummaryDump": this.table.cbpSummary,
            "contractLifecycleDump": this.table.contractLifecycle,
            "fieldNoticesDump": this.table.fieldNotices,
            "cbpDetailsDump": this.table.cbpDetails,
            "riskMitigationDetailsDump": this.table.riskMitigationDetails,
            "riskMitigationSummaryDump": this.table.riskMitigationSummary,
            "deviceResetCountDump": this.table.deviceResetCount,
            "deviceResetLastResetDetailsDump": this.table.deviceResetLastResetDetails,
            "deviceResetHistoryDump": this.table.deviceResetHistory,
            "cbpRulesReferencesDump": this.table.cbpRulesReferences,

            "softwaretrackSummaryDump": this.table.softwaretrackSummary,
            "softwaretrackMembersDump": this.table.softwaretrackMembers,
            "softwaretrackComplianceDump": this.table.softwaretrackCompliance,
            "softwaretrackReccommendationsDump": this.table.softwaretrackReccommendations,
            "syslogDump": this.table.syslogDaily,
            "placeInNetworkDump": this.table.placeInNetwork,
            "unidentifiedInventoryDetailsDump": this.table.unidentifiedInventoryDetails
            // "unidentifiedInventorysummaryDump": this.table.unidentifiedInventorysummary

        };
        return dump_target_relation[tableName] + "";
    },

    setDeletedFlag: function() {

        try {
            var target_table = "";

            var dump_target_relation = {
                "devicesDump": this.table.devices,
                "softwareLifecycleBulletinsDump": this.table.softwareLifecycleBulletin,
                "hardwareLifecycleBulletinDump": this.table.hardwareLifecycleBulletin,
                "securityAdvisoriesbulletinDump": this.table.securityAdvisoryBulletins,
                "fiedlNoticesBulletinDump": this.table.fieldNoticesBulletin,
                "assetsDump": this.table.assets,
                "cbpRulesDump": this.table.cbpRules,
                "securityAdvisoriesDump": this.table.securityAdvisories,
                "hardwareLifecycleDump": this.table.hardwareLifecycle,
                "softwareLifecycleDump": this.table.softwareLifecycle,
                "cbpSummaryDump": this.table.cbpSummary,
                "contractLifecycleDump": this.table.contractLifecycle,
                "fieldNoticesDump": this.table.fieldNotices,
                "cbpDetailsDump": this.table.cbpDetails,
                "riskMitigationDetailsDump": this.table.riskMitigationDetails,
                "riskMitigationSummaryDump": this.table.riskMitigationSummary,
                "deviceResetCountDump": this.table.deviceResetCount,
                "deviceResetLastResetDetailsDump": this.table.deviceResetLastResetDetails,
                "deviceResetHistoryDump": this.table.deviceResetHistory,
                "cbpRulesReferencesDump": this.table.cbpRulesReferences,
                "softwaretrackSummaryDump": this.table.softwaretrackSummary,
                "softwaretrackMembersDump": this.table.softwaretrackMembers,
                "softwaretrackComplianceDump": this.table.softwaretrackCompliance,
                "softwaretrackReccommendationsDump": this.table.softwaretrackReccommendations,
                "syslogDump": this.table.syslogDaily,
                "placeInNetworkDump": this.table.placeInNetwork,
                "unidentifiedInventoryDetailsDump": this.table.unidentifiedInventoryDetails
                //"unidentifiedInventorysummaryDump": this.table.unidentifiedInventorysummary
            };

            for (var table in dump_target_relation) {
                var grDelete = new GlideRecord(dump_target_relation[table]);
                grDelete.query();
                while (grDelete.next()) {
                    grDelete.isdeleted = true;
                    grDelete.update();
                }
            }

        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.setDeletedFlag . Error :- " + e);
        }
    },

    setDeleteFlagTrueForNegativeSync: function(tableName) {
        var grDelete = new GlideRecord(this.table[tableName]);
        grDelete.query();
        while (grDelete.next()) {
            grDelete.isdeleted = true;
            grDelete.update();
        }
    },

    deleteRecords: function() {
        var dump_target_relation = {
            "devicesDump": this.table.devices,
            "softwareLifecycleBulletinsDump": this.table.softwareLifecycleBulletin,
            "hardwareLifecycleBulletinDump": this.table.hardwareLifecycleBulletin,
            "securityAdvisoriesbulletinDump": this.table.securityAdvisoryBulletins,
            "fiedlNoticesBulletinDump": this.table.fieldNoticesBulletin,
            "assetsDump": this.table.assets,
            "cbpRulesDump": this.table.cbpRules,
            "securityAdvisoriesDump": this.table.securityAdvisories,
            "hardwareLifecycleDump": this.table.hardwareLifecycle,
            "softwareLifecycleDump": this.table.softwareLifecycle,
            "cbpSummaryDump": this.table.cbpSummary,
            "contractLifecycleDump": this.table.contractLifecycle,
            "fieldNoticesDump": this.table.fieldNotices,
            "cbpDetailsDump": this.table.cbpDetails,
            "riskMitigationDetailsDump": this.table.riskMitigationDetails,
            "riskMitigationSummaryDump": this.table.riskMitigationSummary,
            "deviceResetLastResetDetailsDump": this.table.deviceResetLastResetDetails,
            "deviceResetCountDump": this.table.deviceResetCount,
            "deviceResetHistoryDump": this.table.deviceResetHistory,
            "cbpRulesReferencesDump": this.table.cbpRulesReferences,
            "softwaretrackSummaryDump": this.table.softwaretrackSummary,
            "softwaretrackMembersDump": this.table.softwaretrackMembers,
            "softwaretrackComplianceDump": this.table.softwaretrackCompliance,
            "softwaretrackReccommendationsDump": this.table.softwaretrackReccommendations,
            "syslogDump": this.table.syslogDaily,
            "placeInNetworkDump": this.table.placeInNetwork,
            "unidentifiedInventoryDetailsDump": this.table.unidentifiedInventoryDetails
            //"unidentifiedInventorysummaryDump": this.table.unidentifiedInventorysummary
        };

        for (var table in dump_target_relation) {
            try {
                var grDelete = new GlideRecord(dump_target_relation[table]);
                grDelete.addQuery("isdeleted", true);
                grDelete.query();
                //                 if (table == "devicesDump" || table == "assetsDump") {
                //                     while (grDelete.next()) {
                //                         grDelete.install_status = "7";
                //                         grDelete.update();
                //                     }
                //                 } else {
                //                     this.logger.info("Inside Cisco_DAOScript.deleteRecords performing deletion into " + dump_target_relation[table] + " deleted records.");
                grDelete.deleteMultiple();

                // }
            } catch (e) {
                this.logger.info("Inside Cisco_DAOScript.deleteRecords performing deletion Error found - " + e);
            }
        }
    },

    insertIntoIntermediateDump: function(tableName, clientid, response) {
        try {
            //this.setDeletedFlag(tableName);
            this.logger.debug("Inside Cisco_DAOScript.insertIntoIntermediateDump performing insertion into " + this.table[tableName]);
            gs.info("Inside Cisco_DAOScript.insertIntoIntermediateDump " + tableName + ' : ' + this.table[tableName] + ' : ' + response);
            var jsonParse = JSON.parse(response);
            gs.info("Inside parsed Cisco_DAOScript.insertIntoIntermediateDump" + tableName + ' : ' + jsonParse + jsonParse.length);
            for (var i = 0; i < jsonParse.length; i++) {
                var field = '';
                var gr = new GlideRecord(this.table[tableName]);
                gr.initialize();
                for (var key in jsonParse[i]) {
                    field = jsonParse[i][key];
                    if (field || field == 0) {
                        gs.info("Inside stringify Cisco_DAOScript.insertIntoIntermediateDump" + this.table[tableName] + ' : ' + JSON.stringify(field));
                        gr[key.toLowerCase()] = (field.constructor === Object || field.constructor === Array) ? JSON.stringify(field) : field + '';

                    }
                }

                gr.customer_id = clientid;
                gr.insert();
            }
        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.insertIntoIntermediateDump while inserting data into intermediate dump table. Error :- " + e);
        }
    },
    checkWhetherAnyScheduleJobIsRunningOrNot: function() {
        var grQueue = new GlideRecord("x_caci_cisco_bcs_cisco_import_queue");
        grQueue.addQuery("state", "processing");
        grQueue.query();
        if (grQueue.next())
            return true;
        else
            return false;
    },
    clearApplicationData: function(clientid) {
        try {
            this.logger.debug("Inside Cisco_DAOScript.clearApplicationData deleting application data.");
            gs.setProperty("x_caci_cisco_bcs.start.import", false);
            gs.setProperty("x_caci_cisco_bcs.core_company", "");
            var checkScheduleJob = this.checkWhetherAnyScheduleJobIsRunningOrNot();
            if (!checkScheduleJob) {
                var applicationTables = ["processQueue", "hardwareLifecycle", "softwareLifecycle", "fieldNotices", "securityAdvisories", "cbpDetails", "cbpRules", "cbpSummary", "hardwareLifecycleBulletin", "softwareLifecycleBulletin", "securityAdvisoryBulletins", "fieldNoticesBulletin", "contractLifecycle", "cbpRulesReferences", "assets", "devices", "riskMitigationDetails", "riskMitigationSummary", "deviceResetCount", "deviceResetLastResetDetails", "deviceResetHistory", "cbpRulesReferences", "softwaretrackSummary", "softwaretrackMembers", "softwaretrackCompliance", "softwaretrackReccommendations", "syslogDaily", "deviceName", "devicehistoryRelation", "placeInNetwork", "unidentifiedInventoryDetails"];
                for (var i in applicationTables) {
                    var gr = new GlideRecord(this.table[applicationTables[i]]);
                    gr.addQuery("customer_id", clientid);
                    gr.deleteMultiple();
                }

                //                 var cmdb_tables = ["assets", "devices"];
                //                 for (var j in cmdb_tables) {
                //                     var gr = new GlideRecord(this.table[cmdb_tables[j]]);
                //                     gr.query();
                //                     while (gr.next()) {
                //                         gr.install_status = 7;
                //                         gr.update();
                //                     }
                //                 }
                var authRec = new GlideRecord(this.table.authentication);
                if (authRec.get(this.property.authRec)) {
                    authRec.name = "";
                    authRec.host_name = "";
                    authRec.customer_id = "";
                    authRec.api_key = "";
                    authRec.access_token = "";
                    authRec.time_left = "";
                    authRec.log_level = "0";
                    authRec.users_list = "";
                    authRec.update();
                }

                return true;
            } else
                return false;


        } catch (e) {
            this.logger.error("Exception Inside Cisco_DAOScript.clearApplicationData() deleting application data." + e);
        }
    },

    deleteSyslogRecords: function() {
        try {
            this.logger.debug("Inside Cisco_DAOScript.deleteSyslogRecords deleting old syslog data.");
            var last_date = gs.getProperty("x_caci_cisco_bcs.syslog.lastDate") + '';

            var applicationTables = ["syslogDaily", "deviceName"];
            for (var i in applicationTables) {
                var gr_syslog = new GlideRecord(this.table[applicationTables[i]]);
                gr_syslog.addEncodedQuery('dateRELATIVELT@dayofweek@ago@' + last_date);
                gr_syslog.deleteMultiple();
            }

            return true;

        } catch (e) {
            this.logger.error("Exception Inside Cisco_DAOScript.deleteSyslogRecords deleting old syslog data." + e);
        }
    },

    deleteProcessQueue: function() {
        try {
            this.logger.debug("Inside Cisco_DAOScript.deleteProcessQueue Deleting data in process queue older than yesterday.");

            var queueObj = new GlideRecord(this.table.processQueue);
            queueObj.addEncodedQuery("sys_created_on<=javascript:gs.endOfYesterday()");
            queueObj.deleteMultiple();

        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.deleteProcessQueue while Deleting data in process queue older than yesterday. Error :- " + e);
        }

    },

    getReferenceMapping: function(table_name, field_name, target_data) {
        try {
            this.logger.debug("Inside Cisco_DAOScript.getReferenceMapping mapping reference of tables");
            var grRef = new GlideRecord(this.table[table_name]);
            grRef.addQuery(field_name, target_data);
            grRef.query();
            if (grRef.next())
                return grRef.sys_id;

            this.logger.warn("Inside Cisco_DAOScript.getReferenceMapping Could not find record for " + field_name + " in table " + table_name);
            return "";

        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.getReferenceMapping while mapping tables. Error :- " + e);
        }
    },

    getDataOfCalculatedFields: function(tableName, reference, matchConfidence, fieldName, groupBy) {
        try {
            this.logger.debug("Inside Cisco_DAOScript.getDataOfCalculatedFields calculating vulnerable and potentially vulnerable count");
            var count = 0;
            var fn_arr = [];
            var arrayUtil = new global.ArrayUtil();
            var calculateData = new GlideRecord(this.table[tableName]);
            calculateData.addQuery(fieldName, reference[fieldName]);
            calculateData.addQuery("match_confidence", matchConfidence);
            calculateData.query();
            while (calculateData.next()) {
                if (!arrayUtil.contains(fn_arr, calculateData[groupBy])) {
                    fn_arr.push(calculateData[groupBy] + "");
                    count = count + 1;
                }
            }

            return count;

        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.getDataOfCalculatedFields while calculating vulnerable and potentially vulnerable count. Error :- " + e);
        }


    },

    // 	getDataOfCalculatedSecurityAdvisories: function(tableName, reference, matchConfidence,fieldName ) {
    // 		try {
    // 			this.logger.debug("Inside Cisco_DAOScript.getDataOfCalculatedSecurityAdvisories calculating vulnerable and potentially vulnerable count");
    // 			var count = 0;
    // 			var fn_arr = [];
    // 			var arrayUtil = new global.ArrayUtil();
    // 			var calculateData = new GlideRecord(this.table[tableName]);
    // 			calculateData.addQuery(fieldName, reference[fieldName]);
    // 			calculateData.addQuery("match_confidence", matchConfidence);
    // 			calculateData.query();
    // 			while (calculateData.next()) {
    // 				if(!arrayUtil.contains(fn_arr , calculateData[groupBy]+""))
    // 					fn_arr.push(calculateData[groupBy]+"");
    // 			}
    // 			//    count = count + 1;
    // 			gs.info("fn_arr "+fn_arr);
    // 			return fn_arr.length;

    // 		} catch (e) {
    // 			this.logger.error("Exception caught inside Cisco_DAOScript.getDataOfCalculatedSecurityAdvisories while calculating vulnerable and potentially vulnerable count. Error :- " + e);
    // 		}
    // 	},

    getConfigurationGuideline: function(reference) {
        var cbpdetails = new GlideAggregate("x_caci_cisco_bcs_cisco_cbp_details");
        cbpdetails.addQuery("device_id", reference.device_id);
        cbpdetails.addAggregate("COUNT", "device_id");
        cbpdetails.query();
        if (cbpdetails.next()) {
            return (cbpdetails.getAggregate("COUNT", "device_id"));
        }
    },

    getDataOfFeedbackForm: function(response) {
        try {

            var feedbackResponse = JSON.parse(response);
            var rating = feedbackResponse[0];
            var comment = feedbackResponse[2];
            var view = feedbackResponse[1];
            var ratingView = feedbackResponse[3];
            if (gs.getUser().getEmail())
                var username = gs.getUser().getEmail();
            else
                var username = "unknown@unknown.com";
            var feedbackform = new GlideRecord("x_caci_cisco_bcs_cisco_bcs_feedback_form");
            feedbackform.initialize();
            feedbackform.setValue("rating", rating);
            feedbackform.setValue("overall_feedback", comment);
            feedbackform.setValue("drilldown_view", view);
            feedbackform.setValue("username", username);
            feedbackform.setValue("feedback_view", ratingView);
            feedbackform.setValue("user_name", gs.getUserName() + "");
            feedbackform.insert();
            return true;



        } catch (e) {
            this.logger.error("Exception caught inside Cisco_DAOScript.getDataOfFeedbackForm.Error : " + e);
        }
    },
    getContractDrillDown: function(tab) {
        var result = [];
        if (tab == "Warranty") {
            var warrantyDates = {};
            var count_out = 0;

            var aggContract = new GlideRecord('x_caci_cisco_bcs_cisco_contract_lifecycle');
            aggContract.addEncodedQuery("warranty_end_date<javascript:gs.beginningOfToday()");
            aggContract.query();
            while (aggContract.next()) {
                count_out++;
            }
            (count_out + "" == "0") ? "" : (warrantyDates["Out of warranty"] = count_out);

            var count_in = 0;
            aggContract = new GlideRecord('x_caci_cisco_bcs_cisco_contract_lifecycle');
            aggContract.addEncodedQuery("warranty_end_date>javascript:gs.endOfToday()");
            aggContract.query();
            while (aggContract.next()) {
                count_in++;
            }
            (count_in + "" == "0") ? "" : (warrantyDates["Under warranty"] = count_in);
            result[0] = warrantyDates;
            return JSON.stringify(result);
        } else {
            var contractDates = {};
            var count_out = 0;

            var aggContract = new GlideRecord('x_caci_cisco_bcs_cisco_contract_lifecycle');
            aggContract.addQuery('is_covered', 'NO');
            aggContract.query();
            while (aggContract.next()) {
                count_out++;
            }
            (count_out + "" == "0") ? "" : (contractDates["Expired contract"] = count_out);

            var count_in = 0;
            aggContract = new GlideRecord('x_caci_cisco_bcs_cisco_contract_lifecycle');
            aggContract.addQuery('is_covered', 'YES');
            aggContract.query();
            while (aggContract.next()) {
                count_in++;
            }
            (count_in + "" == "0") ? "" : (contractDates["Under contract"] = count_in);
            result[0] = contractDates;
            return JSON.stringify(result);
        }
    },
    gettingOptionsForConfigurationDrillDown: function() {
        var id = this.getclientid();
        var CBPDrillDown = new GlideAggregate('x_caci_cisco_bcs_cisco_cbp_summary');
        CBPDrillDown.addQuery('customer_id', id);
        CBPDrillDown.addAggregate('COUNT', 'sw_type');
        CBPDrillDown.setGroup(true);
        CBPDrillDown.query();
        var arr = [];
        while (CBPDrillDown.next()) {
            arr.push(CBPDrillDown.sw_type + "");
        }
        return JSON.stringify(arr);
    },
    gettingDataForConfigurationsButton2: function(param) {
        if (param == "All")
            param = "ANYTHING";
        else
            param = "=" + param;
        var CBPSWtype = new GlideRecord("x_caci_cisco_bcs_cisco_cbp_summary");
        CBPSWtype.addEncodedQuery("sw_type" + param);
        CBPSWtype.query();
        var count = 0;
        while (CBPSWtype.next()) {
            count = count + parseInt(CBPSWtype.total_devices);
        }
        return count;
    },
    gettingDataForConfigurationsButton1: function(param, param1) {

        if (param == "All")
            param = "ANYTHING";
        else
            param = "=" + param;
        if (param1 == "All")
            param1 = "ANYTHING";
        else
            param1 = "=" + param1;
        var id = this.getclientid();
        var CBPButton = new GlideAggregate('x_caci_cisco_bcs_cisco_cbp_summary');
        CBPButton.addQuery('customer_id', id);
        CBPButton.addAggregate('COUNT', 'bp_rule_id');
        CBPButton.addEncodedQuery('sw_type' + param);
        CBPButton.addEncodedQuery('bp_risk' + param1);
        CBPButton.setGroup(true);
        CBPButton.query();
        var count = 0;
        while (CBPButton.next()) {
            count++;
        }
        return count;
    },
    configurationSecondGraph: function(param, param1) {

        if (param == "All")
            param = "ANYTHING";
        else
            param = "=" + param;
        if (param1 == "All")
            param1 = "ANYTHING";
        else
            param1 = "=" + param1;
        /*var ga = new GlideAggregate('x_caci_cisco_bcs_cisco_cbp_summary');
        ga.addAggregate('COUNT', 'bp_primary_technology');
        ga.addEncodedQuery("sw_type" + param);
        ga.setGroup(true);
        ga.query();
        var count = 0;
        var data = [];
        var json = {};
        while (ga.next()) {
        	json = {};
        	var records = 0;
        	var gr = new GlideRecord("x_caci_cisco_bcs_cisco_cbp_summary");
        	gr.addQuery("bp_primary_technology", ga.bp_primary_technology);
        	gr.addEncodedQuery('sw_type' + param);
        	gr.query();
        	while (gr.next()) {
        		records = records+ parseInt(gr.total_devices);
        	}
        	json.key = ga.bp_primary_technology+"";
        	json.count = records;
        	data.push(json);
        }
        data.sort(function(a, b) {
        	var x = a.count;
        	var y = b.count;
        	if (y < x) {
        		return -1;
        	}
        	if (y > x) {
        		return 1;
        	}
        	return 0;
        });
        var range = data.length;
        if (range > 10)
        	range = 10;
        var result = {};
        for (var i = 0; i < range; i++) {
        	var obj = data[i];
        	result[obj.key] = obj.count;
        }
        return JSON.stringify(result);*/

        var final_answer = [];
        //var result = [];
        var output = {};
        var button_arr = [];
        var count = 0;
        var i = 0;
        var clientid = this.getclientid();
        var CBPtech = new GlideAggregate('x_caci_cisco_bcs_cisco_cbp_summary');
        CBPtech.addQuery('customer_id', clientid);
        CBPtech.addAggregate('COUNT', 'bp_primary_technology');
        CBPtech.addEncodedQuery("sw_type" + param);
        CBPtech.addEncodedQuery("bp_risk" + param1);
        CBPtech.setGroup(true);
        CBPtech.query();
        while (CBPtech.next()) {
            var id = (CBPtech.bp_primary_technology + "");
            var getId = new GlideRecord('x_caci_cisco_bcs_cisco_cbp_summary');
            getId.addQuery('customer_id', clientid);
            getId.addQuery('bp_primary_technology', id);
            getId.addEncodedQuery("sw_type" + param);
            getId.addEncodedQuery("bp_risk" + param1);
            //ga.setGroup(true);
            getId.query();
            var result = [];
            while (getId.next()) {
                var CBPrule = new GlideRecord("x_caci_cisco_bcs_cisco_cbp_details");
                CBPrule.addQuery('customer_id', clientid);
                CBPrule.addQuery('bp_rule_id', getId.bp_rule_id);
                CBPrule.query();
                while (CBPrule.next()) {
                    if (result.indexOf(CBPrule.device_id + "") < 0)
                        result.push(CBPrule.device_id + "");
                    if (button_arr.indexOf(CBPrule.device_id + "") < 0)
                        button_arr.push(CBPrule.device_id + "");
                }
            }
            output[id] = result.length + "";
        }
        var data = [];
        for (var i in output) {
            var json = {};
            json.key = i + "";
            json.count = parseInt(output[i] + "");
            data.push(json);
        }

        data.sort(function(a, b) {
            var x = a.count;
            var y = b.count;
            if (y < x) {
                return -1;
            }
            if (y > x) {
                return 1;
            }
            return 0;
        });

        var range = data.length;
        if (range > 10)
            range = 10;
        var result1 = {};
        for (var i = 0; i < range; i++) {
            var obj = data[i];
            result1[obj.key] = obj.count;
        }
        final_answer[0] = result1;
        final_answer[1] = button_arr.length;
        return JSON.stringify(final_answer);

    },

    configurationFirstGraph: function(param, param1) {
        if (param == "All")
            param = "ANYTHING";
        else
            param = "=" + param;
        if (param1 == "All")
            param1 = "ANYTHING";
        else
            param1 = "=" + param1;
        var id = this.getclientid();
        var CBPtech = new GlideAggregate('x_caci_cisco_bcs_cisco_cbp_summary');
        CBPtech.addQuery('customer_id', id);
        CBPtech.addAggregate('COUNT', 'bp_primary_technology');
        CBPtech.orderByAggregate('COUNT', 'bp_primary_technology');
        CBPtech.addEncodedQuery("sw_type" + param);
        CBPtech.addEncodedQuery("bp_risk" + param1);
        CBPtech.setGroup(true);
        CBPtech.query();
        var count = 0;
        var data = {};
        while (CBPtech.next() && count < 10) {
            data[CBPtech.bp_primary_technology] = CBPtech.getAggregate('COUNT', 'bp_primary_technology');
            count++;
        }
        return JSON.stringify([data]);
    },
    getclientid: function() {
        var user = gs.getUserID();
        var id;

        var bcs = new GlideRecord("x_caci_cisco_bcs_configuration");
        if (!gs.hasRole('admin')) {
            bcs.addQuery('users_list', user);
        }
        bcs.orderByDesc('updated');
        bcs.setLimit(1);
        bcs.query();
        while (bcs.next()) {
            //gs.info("customer_id" + bcs.customer_id);
            id = bcs.customer_id;
        }

        return id;
    },
    predictedimportanceDetails: function(selfFieldValue, targetField, targetTable, ClientId) {
        var pindetail = new GlideRecord(targetTable);
        pindetail.addQuery("customer_id", ClientId);
        pindetail.addQuery(targetField, selfFieldValue);
        pindetail.query();
        if (pindetail.next()) {
            return pindetail.predictedimportance;
        }
    },
    predictedroleDetails: function(selfFieldValue, targetField, targetTable, ClientId) {
        var pinpredictedimp = new GlideRecord(targetTable);
        pinpredictedimp.addQuery("customer_id", ClientId);
        pinpredictedimp.addQuery(targetField, selfFieldValue);
        pinpredictedimp.query();
        if (pinpredictedimp.next()) {
            return pinpredictedimp.predictedrole;
        }
    },
    updateIncidentWorkNotes: function(currentObj, previousObj) {

        var incidentIds = currentObj.incident_reference.toString();
        var incidentListID = incidentIds.split(",");
        for (var i = 0; i < incidentListID.length; i++) {
            var worknotes = [];
            var incidentupdate = new GlideRecord("incident");
            incidentupdate.addQuery("sys_id", incidentListID[i].toString());
            incidentupdate.query();
            if (incidentupdate.next()) {
                for (var property in currentObj) {
                    if (!property.startsWith("sys_")) {

                        if (currentObj[property] != previousObj[property]) {
                            worknotes.push(currentObj[property].getLabel() + " : " + previousObj[property].toString() + " changes to " + currentObj[property].toString());
                        }
                    }
                }
                incidentupdate.work_notes = currentObj.devicename + " Device is updated with following values :" + "\n" + worknotes.join("\n");
                incidentupdate.update();
                var list = {};
                list.push(currentObj);
                var newIncidentRealltionship = new GlideRecord('x_caci_cisco_bcs_incident_device_relationship');
                newIncidentRealltionship.initialize();
                newIncidentRealltionship.setValue('incident_reference', incidentListID[i].toString());
                newIncidentRealltionship.setValue('list_of_devices', JSON.stringify(list, 0, 4));
                newIncidentRealltionship.insert();
            }
        }
    },
  
    type: 'Cisco_DAOScript'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-10-15 13:48:31</sys_created_on>
        <sys_id>8319a1b62f7310108956ea5ef699b6e4</sys_id>
        <sys_mod_count>369</sys_mod_count>
        <sys_name>Cisco_DAOScript</sys_name>
        <sys_package display_value="Cisco BCS Operational Insights" source="x_caci_cisco_bcs">56b8d9362f3310108956ea5ef699b62d</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Cisco BCS Operational Insights">56b8d9362f3310108956ea5ef699b62d</sys_scope>
        <sys_update_name>sys_script_include_8319a1b62f7310108956ea5ef699b6e4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2022-11-15 12:18:01</sys_updated_on>
    </sys_script_include>
</record_update>
